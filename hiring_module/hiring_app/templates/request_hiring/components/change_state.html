<form id="changeStateForm" method="post" action="{% url 'hiring_app:change_state' contract_request.id %}"
    style="margin-bottom: 1rem;">
    {% csrf_token %}
    <label for="state" style="margin-right: 0.5rem; color: #4a5568; font-weight: 600;">Estado:</label>
    <select name="state" id="stateSelect"
        style="padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #cbd5e0; outline: none; transition: border-color 0.15s ease-in-out;">
        {% for choice in choices %}
        {% if choice.0 == contract_request.state %}
        <option value="{{ choice.0 }}" selected style="color: #4a5568;">{{ choice.1 }}</option>
        {% else %}
        <option value="{{ choice.0 }}" style="color: #4a5568;">{{ choice.1 }}</option>
        {% endif %}
        {% endfor %}
    </select>
</form>

<div id="commentBox" class="comment-box"
    style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1); z-index: 9999;">
    <textarea id="commentInput" placeholder="Ingrese el motivo"
        style="width: 100%; margin-bottom: 10px; padding: 5px; border-radius: 3px; border: 1px solid #ccc;"></textarea>
    <button id="commentSubmitBtn"
        style="margin-right: 10px; padding: 8px 16px; border: none; background-color: #1e3a8a; color: white; border-radius: 3px; cursor: pointer;">Enviar</button>
    <button id="commentCancelBtn"
        style="padding: 8px 16px; border: 1px solid #1e3a8a; background-color: transparent; color: #1e3a8a; border-radius: 3px; cursor: pointer;">Cancelar</button>
</div>

<div id="alertBox" class="alert-box"
    style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #ff4444; padding: 20px; border-radius: 5px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1); z-index: 9999; color: white; font-weight: bold; text-align: center;">
    Mensaje de Alerta
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var selectElement = document.getElementById('stateSelect');
        var commentBox = document.getElementById('commentBox');
        var commentInput = document.getElementById('commentInput');
        var alertBox = document.getElementById('alertBox');
        var previousState = "{{ contract_request.state }}"; // Usamos el valor directamente desde Django

        selectElement.addEventListener('change', function () {
            if (this.value === 'incomplete' || this.value === 'cancelled') {
                commentBox.style.display = 'block';
            } else {
                commentBox.style.display = 'none';
            }
        });

        document.getElementById('commentSubmitBtn').addEventListener('click', function () {
            var reason = commentInput.value.trim();
            if (reason !== '') {
                // Agregar el motivo al formulario como un campo oculto
                var reasonInput = document.createElement('input');
                reasonInput.type = 'hidden';
                reasonInput.name = 'reason';
                reasonInput.value = reason;
                document.getElementById('changeStateForm').appendChild(reasonInput);

                // Enviar el formulario después de manejar el motivo
                document.getElementById('changeStateForm').submit();
            } else {
                // Aquí puedes manejar el caso cuando el comentario está vacío
                showAlert("Por favor ingrese un comentario");
            }
        });

        document.getElementById('commentCancelBtn').addEventListener('click', function () {
            commentBox.style.display = 'none';
            // Restaurar el estado anterior del select
            selectElement.value = previousState;
        });

        function showAlert(message) {
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            setTimeout(function () {
                alertBox.style.display = 'none';
            }, 1500); // Ocultar después de 3 segundos
        }
    });
</script>
